#!/bin/bash

# ==========================================
# CONFIGURATION
# ==========================================
CONFIG_FILE="$HOME/.cpptest_compiler"
CXX_FLAGS="-std=c++17 -O2 -Wall -Wextra -pedantic -Werror"
TMP_WORK_DIR="/tmp/cpptest/tmp"
REPO_URL="https://github.com/MootSasa/CppTest.git" # Ссылка на ваш репо

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==========================================
# HELPER FUNCTIONS
# ==========================================
find_compilers() {
    IFS=: read -ra PATH_DIRS <<< "$PATH"
    PATTERNS=("g++*" "clang++*" "c++*")
    CANDIDATES=()
    for dir in "${PATH_DIRS[@]}"; do
        [ -d "$dir" ] || continue
        for pat in "${PATTERNS[@]}"; do
            shopt -s nullglob
            for file in "$dir"/$pat; do
                [ -x "$file" ] || continue
                name=$(basename "$file")
                if [[ "$name" =~ ^(g\+\+|clang\+\+|c\+\+)(-[0-9]+)?$ ]]; then
                    CANDIDATES+=("$name")
                fi
            done
            shopt -u nullglob
        done
    done
    readarray -t INSTALLED_COMPILERS < <(printf "%s\n" "${CANDIDATES[@]}" | sort -u | sort -V -r)
}

# ==========================================
# PARSE ARGUMENTS
# ==========================================
CPP_FILE=""
SOURCE_DIR="."
ISOLATE=true        # Default: Copy to tmp
CHECKER_MODE="auto" # auto, force_check (-K), force_diff (-k)
SKIP_LINTER=false   # Default: Run linter
AUTO_FIX=false      # Default: No auto-fix
REMOVE_COMMENTS=false # Default: Keep comments

while [[ $# -gt 0 ]]; do
    case $1 in
        # --- UPDATE FLAG ---
        -u|--update)
            echo -e "${BLUE}Updating CppTest from GitHub...${NC}"
            # Эта команда скачивает репозиторий и запускает install.sh
            CMD="rm -rf /tmp/cpptest_inst && git clone --depth=1 $REPO_URL /tmp/cpptest_inst && bash /tmp/cpptest_inst/install.sh && rm -rf /tmp/cpptest_inst"
            eval "$CMD"
            
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}Update complete! You are on the latest version.${NC}"
                exit 0
            else
                echo -e "${RED}Update failed! Check your internet connection.${NC}"
                exit 1
            fi
            ;;

        -l|--list)
            find_compilers
            echo -e "${BLUE}Detected Compilers:${NC}"
            for i in "${!INSTALLED_COMPILERS[@]}"; do echo " - ${INSTALLED_COMPILERS[$i]}"; done
            exit 0 ;;
        -s|--select)
            find_compilers
            [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No compilers found!${NC}"; exit 1; }
            echo -e "${BLUE}Select default compiler:${NC}"
            select opt in "${INSTALLED_COMPILERS[@]}"; do
                if [ -n "$opt" ]; then
                    echo "$opt" > "$CONFIG_FILE"
                    echo -e "${GREEN}Default compiler set to: $opt${NC}"
                    exit 0
                else echo -e "${RED}Invalid selection${NC}"; fi
            done
            exit 0 ;;
        -c|--compiler)
            [ -z "$2" ] && { echo -e "${RED}Error: Missing compiler name${NC}"; exit 1; }
            echo "$2" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $2${NC}"; exit 0 ;;
        
        # --- FLAGS ---
        -i|--in-place)
            ISOLATE=false
            shift ;;
        -K|--force-checker)
            CHECKER_MODE="force_check"
            shift ;;
        -k|--force-diff)
            CHECKER_MODE="force_diff"
            shift ;;
        -f|--fast)
            SKIP_LINTER=true
            shift ;;
        -F|--fix)
            AUTO_FIX=true
            if [ "$ISOLATE" = true ]; then ISOLATE=false; fi
            shift ;;
        -R|--no-comments)
            REMOVE_COMMENTS=true
            shift ;;
        
        *)
            if [[ -d "$1" ]]; then
                SOURCE_DIR="$1"
            elif [[ -f "$1" ]]; then
                SOURCE_DIR=$(dirname "$1")
                CPP_FILE=$(basename "$1")
            elif [[ "$1" != -* ]]; then
                 CPP_FILE="$1"
            fi
            shift ;;
    esac
done

# ==========================================
# ENVIRONMENT SETUP
# ==========================================
SOURCE_DIR=$(realpath "$SOURCE_DIR")

if [ "$ISOLATE" = true ]; then
    echo -e "${BLUE}=== Environment: Isolated ($TMP_WORK_DIR) ===${NC}"
    rm -rf "$TMP_WORK_DIR"
    mkdir -p "$TMP_WORK_DIR"
    cp -a "$SOURCE_DIR/." "$TMP_WORK_DIR/"
    cd "$TMP_WORK_DIR" || exit 1
else
    echo -e "${BLUE}=== Environment: In-Place ($SOURCE_DIR) ===${NC}"
    cd "$SOURCE_DIR" || exit 1
fi

# ==========================================
# COMPILER SETUP
# ==========================================
if [ -f "$CONFIG_FILE" ]; then
    CHOSEN_CXX=$(cat "$CONFIG_FILE")
    if ! command -v "$CHOSEN_CXX" &> /dev/null; then CHOSEN_CXX=""; fi
fi
if [ -z "$CHOSEN_CXX" ]; then
    find_compilers
    [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No C++ compiler found!${NC}"; exit 1; }
    CHOSEN_CXX=${INSTALLED_COMPILERS[0]}
    echo -e "${YELLOW}No default set. Using: $CHOSEN_CXX${NC}"
fi

if [ -z "$CPP_FILE" ]; then CPP_FILE=$(ls *.cpp 2>/dev/null | grep -v "check.cpp" | head -n 1); fi
[ -z "$CPP_FILE" ] && { echo -e "${RED}Error: C++ file not found!${NC}"; exit 1; }

EXE_NAME="solution_exec"

# ==========================================
# AUTO FIXER
# ==========================================
if [ "$AUTO_FIX" = true ] && [ "$SKIP_LINTER" = false ]; then
    echo -e "${BLUE}=== Applying Auto-Fixes ===${NC}"
    if command -v clang-format &> /dev/null; then
        clang-format -i "$CPP_FILE"
        echo " - Formatting applied."
    fi
    if command -v clang-tidy &> /dev/null; then
        echo " - Applying Clang-Tidy fixes..."
        clang-tidy -quiet --fix "$CPP_FILE" -- $CXX_FLAGS > /dev/null 2>&1
    fi
    echo -e "${GREEN}Fixes applied.${NC}\n"
fi

# ==========================================
# COMMENT REMOVER (-R)
# ==========================================
CLEAN_SOURCE_FILE=""
if [ "$REMOVE_COMMENTS" = true ]; then
    echo -e "${BLUE}=== Removing Comments ===${NC}"
    CLEAN_SOURCE_FILE="${CPP_FILE%.*}.clean.cpp"
    perl -0777 -pe 's{ ("(?:\\. | [^\\"])*") | /\*.*?\*/ | // [^\n]* }{ $1 || "" }gsex' "$CPP_FILE" > "$CLEAN_SOURCE_FILE"
    echo " - Original: $CPP_FILE"
    echo " - Cleaned:  $CLEAN_SOURCE_FILE"
    CPP_FILE="$CLEAN_SOURCE_FILE"
    echo -e "${GREEN}Comments removed. Using clean file for testing.${NC}\n"
fi

# ==========================================
# LINTERS
# ==========================================
if [ "$SKIP_LINTER" = false ]; then
    if command -v clang-format &> /dev/null; then
        echo -e "${BLUE}=== Checking Formatting ===${NC}"
        clang-format --dry-run --Werror "$CPP_FILE" 2> /dev/null
        if [ $? -ne 0 ]; then
            echo -e "${RED}CLANG-FORMAT FAILED${NC}"
            echo -e "Run with ${GREEN}-F${NC} to fix automatically."
            [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"
            exit 1
        fi
        echo -e "${BLUE}Formatting OK.${NC}\n"
    fi

    if command -v clang-tidy &> /dev/null; then
        echo -e "${BLUE}=== Running Clang-Tidy ===${NC}"
        clang-tidy -quiet "$CPP_FILE" -- $CXX_FLAGS
        if [ $? -ne 0 ]; then
            echo -e "\n${RED}CLANG-TIDY FAILED (Code quality issues)${NC}"
            echo -e "Run with ${GREEN}-F${NC} to try auto-fixing."
            [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"
            exit 1
        fi
        echo -e "${BLUE}Analysis complete.${NC}\n"
    fi
else
    echo -e "${YELLOW}Skipping linters (-f used).${NC}\n"
fi

# ==========================================
# COMPILATION & TESTING
# ==========================================
echo -e "${BLUE}=== Compiling $CPP_FILE with $CHOSEN_CXX ===${NC}"
$CHOSEN_CXX $CXX_FLAGS "$CPP_FILE" -o "$EXE_NAME"
if [ $? -ne 0 ]; then 
    echo -e "${RED}COMPILATION ERROR${NC}"
    [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"
    exit 1 
fi
echo -e "${GREEN}Compilation successful!${NC}\n"

CHECKER_EXE="checker_exec"
HAS_CHECKER=false

if [ "$CHECKER_MODE" == "force_diff" ]; then
    echo -e "${BLUE}Mode: Forced Standard Diff (-k)${NC}"
elif [ -f "check.cpp" ]; then
    echo -e "${BLUE}=== Compiling Custom Checker (check.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "check.cpp" -o "$CHECKER_EXE"
    if [ $? -ne 0 ]; then echo -e "${RED}CHECKER COMPILATION ERROR${NC}"; exit 1; fi
    HAS_CHECKER=true
    echo -e "${GREEN}Checker ready.${NC}\n"
else
    if [ "$CHECKER_MODE" == "force_check" ]; then
        echo -e "${RED}Error: Custom checker (-K) requested, but 'check.cpp' not found!${NC}"; exit 1
    fi
    echo -e "${BLUE}Mode: Standard Diff (check.cpp not found)${NC}\n"
fi

TESTS_FOUND=false
for input_file in *.in; do
    [ -e "$input_file" ] || continue
    TESTS_FOUND=true
    test_name=$(basename "$input_file" .in)
    expected_file="${test_name}.out"
    my_output="${test_name}.my"
    echo -n "Test $test_name: "
    
    start_time=$(date +%s%N)
    ./"$EXE_NAME" < "$input_file" > "$my_output"
    exit_code=$?
    end_time=$(date +%s%N)
    duration=$(( ($end_time - $start_time) / 1000000 ))

    if [ $exit_code -ne 0 ]; then
        echo -e "${RED}RUNTIME ERROR (Code $exit_code)${NC} [${duration}ms]"
        continue
    fi

    VERDICT="OK"
    if [ "$HAS_CHECKER" = true ]; then
        if [ ! -f "$expected_file" ]; then touch "$expected_file"; fi
        ./"$CHECKER_EXE" "$input_file" "$my_output" "$expected_file" > /dev/null 2>&1
        if [ $? -eq 0 ]; then VERDICT="OK"; else VERDICT="WA"; fi
    else
        if [ ! -f "$expected_file" ]; then
             if [ "$CHECKER_MODE" == "force_diff" ]; then echo -e "${RED}Error: .out file missing (-k active)${NC}"; continue; else VERDICT="RUN"; fi
        else
             if diff -w -B "$my_output" "$expected_file" > /dev/null; then VERDICT="OK"; else VERDICT="WA"; fi
        fi
    fi

    if [ "$VERDICT" == "OK" ]; then
        echo -e "${GREEN}OK${NC} [${duration}ms]"
        rm "$my_output"
    elif [ "$VERDICT" == "RUN" ]; then
        echo -e "${BLUE}Run (no .out)${NC} [${duration}ms]"
        rm "$my_output"
    else
        echo -e "${RED}WA (Wrong Answer)${NC} [${duration}ms]"
        echo -e "${YELLOW}Input:${NC}"; head -n 10 "$input_file"; [ $(wc -l < "$input_file") -gt 10 ] && echo "..."
        if [ -f "$expected_file" ]; then echo -e "${YELLOW}Expected:${NC}"; head -n 10 "$expected_file"; [ $(wc -l < "$expected_file") -gt 10 ] && echo "..." ; fi
        echo -e "${YELLOW}Got:${NC}"; head -n 10 "$my_output"; [ $(wc -l < "$my_output") -gt 10 ] && echo "..."
        echo "--------------------------------"
    fi
done

# Cleanup
rm -f "$EXE_NAME" "$CHECKER_EXE"
if [ -n "$CLEAN_SOURCE_FILE" ] && [ -f "$CLEAN_SOURCE_FILE" ]; then
    rm "$CLEAN_SOURCE_FILE"
fi

if [ "$TESTS_FOUND" = false ]; then echo -e "${YELLOW}Tests not found (.in files)!${NC}"; fi
