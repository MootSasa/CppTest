#!/bin/bash

# ==========================================
# CONFIGURATION
# ==========================================
CONFIG_FILE="$HOME/.cpptest_compiler"
CXX_FLAGS="-std=c++17 -O2 -Wall -Wextra -pedantic -Werror"
REPO_URL="https://github.com/MootSasa/CppTest.git"

# Default Generator Settings
GEN_DEFAULT_COUNT=100
GEN_DEFAULT_ARGS="-100 100"
GEN_CONFIG_FILE="tests.cfg"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==========================================
# HELPER FUNCTIONS
# ==========================================
find_compilers() {
    IFS=: read -ra PATH_DIRS <<< "$PATH"
    PATTERNS=("g++*" "clang++*" "c++*")
    CANDIDATES=()
    for dir in "${PATH_DIRS[@]}"; do
        [ -d "$dir" ] || continue
        for pat in "${PATTERNS[@]}"; do
            shopt -s nullglob
            for file in "$dir"/$pat; do
                [ -x "$file" ] || continue
                name=$(basename "$file")
                if [[ "$name" =~ ^(g\+\+|clang\+\+|c\+\+)(-[0-9]+)?$ ]]; then
                    CANDIDATES+=("$name")
                fi
            done
            shopt -u nullglob
        done
    done
    readarray -t INSTALLED_COMPILERS < <(printf "%s\n" "${CANDIDATES[@]}" | sort -u | sort -V -r)
}

# ==========================================
# PARSE ARGUMENTS
# ==========================================
CPP_FILE=""
SOURCE_DIR="."
ISOLATE=true
CHECKER_MODE="auto"
SKIP_LINTER=false
AUTO_FIX=false
REMOVE_COMMENTS=false
STRESS_MODE=false
IGNORE_GEN_CONFIG=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--update)
            echo -e "${BLUE}Updating CppTest from GitHub...${NC}"
            CMD="rm -rf /tmp/cpptest_inst && git clone --depth=1 $REPO_URL /tmp/cpptest_inst && bash /tmp/cpptest_inst/install.sh && rm -rf /tmp/cpptest_inst"
            eval "$CMD"
            if [ $? -eq 0 ]; then echo -e "${GREEN}Update complete!${NC}"; exit 0; else echo -e "${RED}Update failed!${NC}"; exit 1; fi ;;
        
        -l|--list) find_compilers; echo -e "${BLUE}Detected Compilers:${NC}"; for i in "${!INSTALLED_COMPILERS[@]}"; do echo " - ${INSTALLED_COMPILERS[$i]}"; done; exit 0 ;;
        
        -s|--select)
            find_compilers; [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No compilers found!${NC}"; exit 1; }
            echo -e "${BLUE}Select default compiler:${NC}"; select opt in "${INSTALLED_COMPILERS[@]}"; do if [ -n "$opt" ]; then echo "$opt" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $opt${NC}"; exit 0; else echo -e "${RED}Invalid selection${NC}"; fi; done; exit 0 ;;
        
        -c|--compiler) [ -z "$2" ] && { echo -e "${RED}Error: Missing compiler name${NC}"; exit 1; }; echo "$2" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $2${NC}"; exit 0 ;;
        
        -i|--in-place) ISOLATE=false; shift ;;
        -K|--force-checker) CHECKER_MODE="force_check"; shift ;;
        -k|--force-diff) CHECKER_MODE="force_diff"; shift ;;
        -f|--fast) SKIP_LINTER=true; shift ;;
        -F|--fix) AUTO_FIX=true; if [ "$ISOLATE" = true ]; then ISOLATE=false; fi; shift ;;
        -R|--no-comments) REMOVE_COMMENTS=true; shift ;;
        
        # --- NEW FLAGS ---
        -S|--stress) STRESS_MODE=true; shift ;;
        -G|--no-gen-config) IGNORE_GEN_CONFIG=true; shift ;;
        
        *)
            if [[ -d "$1" ]]; then SOURCE_DIR="$1"; elif [[ -f "$1" ]]; then SOURCE_DIR=$(dirname "$1"); CPP_FILE=$(basename "$1"); elif [[ "$1" != -* ]]; then CPP_FILE="$1"; fi; shift ;;
    esac
done

# ==========================================
# ENVIRONMENT SETUP
# ==========================================
SOURCE_DIR=$(realpath "$SOURCE_DIR")

# Define Work Directory based on mode
if [ "$STRESS_MODE" = true ]; then
    if [ "$ISOLATE" = true ]; then
        WORK_DIR="/tmp/cpptest/stress"
    else
        WORK_DIR="$SOURCE_DIR/stress"
    fi
else
    if [ "$ISOLATE" = true ]; then
        WORK_DIR="/tmp/cpptest/tmp"
    else
        WORK_DIR="$SOURCE_DIR"
    fi
fi

if [ "$ISOLATE" = true ] || [ "$STRESS_MODE" = true ]; then
    echo -e "${BLUE}=== Environment: $WORK_DIR ===${NC}"
    rm -rf "$WORK_DIR"
    mkdir -p "$WORK_DIR"
    cp -a "$SOURCE_DIR/." "$WORK_DIR/"
    cd "$WORK_DIR" || exit 1
else
    echo -e "${BLUE}=== Environment: In-Place ($SOURCE_DIR) ===${NC}"
    cd "$SOURCE_DIR" || exit 1
fi

# ==========================================
# COMPILER SETUP
# ==========================================
if [ -f "$CONFIG_FILE" ]; then CHOSEN_CXX=$(cat "$CONFIG_FILE"); if ! command -v "$CHOSEN_CXX" &> /dev/null; then CHOSEN_CXX=""; fi; fi
if [ -z "$CHOSEN_CXX" ]; then find_compilers; [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No C++ compiler found!${NC}"; exit 1; }; CHOSEN_CXX=${INSTALLED_COMPILERS[0]}; echo -e "${YELLOW}No default set. Using: $CHOSEN_CXX${NC}"; fi

if [ -z "$CPP_FILE" ]; then CPP_FILE=$(ls *.cpp 2>/dev/null | grep -vE "check.cpp|gen.cpp|fast.cpp" | head -n 1); fi
[ -z "$CPP_FILE" ] && { echo -e "${RED}Error: Main C++ file not found!${NC}"; exit 1; }

EXE_NAME="solution_exec"
GEN_EXE="gen_exec"
FAST_EXE="fast_exec"
CHECKER_EXE="checker_exec"

# ==========================================
# AUTO FIXER & COMMENT REMOVER
# ==========================================
if [ "$AUTO_FIX" = true ] && [ "$SKIP_LINTER" = false ]; then
    echo -e "${BLUE}=== Applying Auto-Fixes ===${NC}"
    if command -v clang-format &> /dev/null; then clang-format -i "$CPP_FILE"; echo " - Formatting applied."; fi
    if command -v clang-tidy &> /dev/null; then echo " - Applying Clang-Tidy fixes..."; clang-tidy -quiet --fix "$CPP_FILE" -- $CXX_FLAGS > /dev/null 2>&1; fi
    echo -e "${GREEN}Fixes applied.${NC}\n"
fi

CLEAN_SOURCE_FILE=""
if [ "$REMOVE_COMMENTS" = true ]; then
    echo -e "${BLUE}=== Removing Comments ===${NC}"
    CLEAN_SOURCE_FILE="${CPP_FILE%.*}.clean.cpp"
    perl -0777 -pe 's{ ("(?:\\. | [^\\"])*") | /\*.*?\*/ | // [^\n]* }{ $1 || "" }gsex' "$CPP_FILE" > "$CLEAN_SOURCE_FILE"
    CPP_FILE="$CLEAN_SOURCE_FILE"
    echo -e "${GREEN}Using clean file: $CPP_FILE${NC}\n"
fi

# ==========================================
# LINTERS
# ==========================================
if [ "$SKIP_LINTER" = false ]; then
    if command -v clang-format &> /dev/null; then
        echo -e "${BLUE}=== Checking Formatting ===${NC}"
        clang-format --dry-run --Werror "$CPP_FILE" 2> /dev/null
        if [ $? -ne 0 ]; then echo -e "${RED}CLANG-FORMAT FAILED${NC} (Use -F to fix)"; [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"; exit 1; fi
        echo -e "${BLUE}Formatting OK.${NC}\n"
    fi
    if command -v clang-tidy &> /dev/null; then
        echo -e "${BLUE}=== Running Clang-Tidy ===${NC}"
        clang-tidy -quiet "$CPP_FILE" -- $CXX_FLAGS
        if [ $? -ne 0 ]; then echo -e "\n${RED}CLANG-TIDY FAILED${NC} (Use -F to fix)"; [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"; exit 1; fi
        echo -e "${BLUE}Analysis complete.${NC}\n"
    fi
else
    echo -e "${YELLOW}Skipping linters (-f used).${NC}\n"
fi

# ==========================================
# COMPILATION (COMMON)
# ==========================================
echo -e "${BLUE}=== Compiling Main ($CPP_FILE) ===${NC}"
$CHOSEN_CXX $CXX_FLAGS "$CPP_FILE" -o "$EXE_NAME"
if [ $? -ne 0 ]; then echo -e "${RED}COMPILATION ERROR${NC}"; [ -n "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"; exit 1; fi

if [ -f "gen.cpp" ]; then
    echo -e "${BLUE}=== Compiling Generator (gen.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "gen.cpp" -o "$GEN_EXE"
    [ $? -ne 0 ] && { echo -e "${RED}GENERATOR COMPILATION ERROR${NC}"; exit 1; }
fi

if [ "$STRESS_MODE" = true ] && [ -f "fast.cpp" ]; then
    echo -e "${BLUE}=== Compiling Brute-Force (fast.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "fast.cpp" -o "$FAST_EXE"
    [ $? -ne 0 ] && { echo -e "${RED}FAST.CPP COMPILATION ERROR${NC}"; exit 1; }
fi

# ==========================================
# STRESS TESTING MODE
# ==========================================
if [ "$STRESS_MODE" = true ]; then
    if [ ! -f "gen.cpp" ] || [ ! -f "fast.cpp" ]; then
        echo -e "${RED}Error: Stress mode requires 'gen.cpp' and 'fast.cpp'.${NC}"; exit 1
    fi

    echo -e "\n${BLUE}=== STARTING STRESS TEST ===${NC}"
    echo -e "Press Ctrl+C to stop.\n"
    
    TEST_COUNT=1
    while true; do
        # Generate random input
        ./"$GEN_EXE" $GEN_DEFAULT_ARGS > stress.in
        
        # Run Solutions
        ./"$EXE_NAME" < stress.in > stress.out
        ./"$FAST_EXE" < stress.in > stress.ans
        
        # Compare
        if diff -w -B stress.out stress.ans > /dev/null; then
            echo -ne "\r${GREEN}Test #$TEST_COUNT: OK${NC}"
        else
            echo -e "\n${RED}Test #$TEST_COUNT: FAILED!${NC}"
            echo -e "${YELLOW}Input:${NC}"; cat stress.in
            echo -e "${YELLOW}Main Output:${NC}"; cat stress.out
            echo -e "${YELLOW}Fast Output:${NC}"; cat stress.ans
            echo "--------------------------------"
            exit 1
        fi
        ((TEST_COUNT++))
    done
fi

# ==========================================
# NORMAL TESTING: GENERATE TESTS
# ==========================================
if [ -f "$GEN_EXE" ]; then
    echo -e "${BLUE}=== Generating Tests ===${NC}"
    CNT=1
    
    generate_batch() {
        local count=$1
        shift
        local args="$@"
        for ((i=1; i<=count; i++)); do
            ./"$GEN_EXE" $args > "gen_${CNT}.in"
            ((CNT++))
        done
        echo " - Generated $count tests with args: $args"
    }

    if [ "$IGNORE_GEN_CONFIG" = false ] && [ -f "$GEN_CONFIG_FILE" ]; then
        echo "Reading $GEN_CONFIG_FILE..."
        while read -r line || [ -n "$line" ]; do
            # Skip empty lines or comments
            [[ "$line" =~ ^#.*$ ]] && continue
            [[ -z "$line" ]] && continue
            
            # Read first word as count, rest as args
            read -r count args <<< "$line"
            generate_batch "$count" "$args"
        done < "$GEN_CONFIG_FILE"
    else
        echo "Using default: 100 tests, args: $GEN_DEFAULT_ARGS"
        generate_batch $GEN_DEFAULT_COUNT $GEN_DEFAULT_ARGS
    fi
    echo -e "${GREEN}Generation complete.${NC}\n"
fi

# ==========================================
# NORMAL TESTING: RUN LOOP
# ==========================================
HAS_CHECKER=false
if [ "$CHECKER_MODE" == "force_diff" ]; then
    echo -e "${BLUE}Mode: Forced Standard Diff (-k)${NC}"
elif [ -f "check.cpp" ]; then
    echo -e "${BLUE}=== Compiling Custom Checker (check.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "check.cpp" -o "$CHECKER_EXE"
    [ $? -ne 0 ] && { echo -e "${RED}CHECKER COMPILATION ERROR${NC}"; exit 1; }
    HAS_CHECKER=true
    echo -e "${GREEN}Checker ready.${NC}\n"
else
    [ "$CHECKER_MODE" == "force_check" ] && { echo -e "${RED}Error: Checker (-K) missing!${NC}"; exit 1; }
fi

TESTS_FOUND=false
# Sort tests naturally (1, 2, 10 instead of 1, 10, 2)
for input_file in $(ls *.in 2>/dev/null | sort -V); do
    TESTS_FOUND=true
    test_name=$(basename "$input_file" .in)
    expected_file="${test_name}.out"
    my_output="${test_name}.my"
    echo -n "Test $test_name: "
    
    start_time=$(date +%s%N)
    ./"$EXE_NAME" < "$input_file" > "$my_output"
    exit_code=$?
    end_time=$(date +%s%N)
    duration=$(( ($end_time - $start_time) / 1000000 ))

    if [ $exit_code -ne 0 ]; then
        echo -e "${RED}RUNTIME ERROR (Code $exit_code)${NC} [${duration}ms]"
        continue
    fi

    VERDICT="OK"
    if [ "$HAS_CHECKER" = true ]; then
        [ ! -f "$expected_file" ] && touch "$expected_file"
        ./"$CHECKER_EXE" "$input_file" "$my_output" "$expected_file" > /dev/null 2>&1
        [ $? -eq 0 ] && VERDICT="OK" || VERDICT="WA"
    else
        if [ ! -f "$expected_file" ]; then
             if [ "$CHECKER_MODE" == "force_diff" ]; then echo -e "${RED}Error: .out missing (-k active)${NC}"; continue; else VERDICT="RUN"; fi
        else
             diff -w -B "$my_output" "$expected_file" > /dev/null && VERDICT="OK" || VERDICT="WA"
        fi
    fi

    if [ "$VERDICT" == "OK" ]; then
        echo -e "${GREEN}OK${NC} [${duration}ms]"
        rm "$my_output"
    elif [ "$VERDICT" == "RUN" ]; then
        echo -e "${BLUE}Run (no .out)${NC} [${duration}ms]"
        rm "$my_output"
    else
        echo -e "${RED}WA (Wrong Answer)${NC} [${duration}ms]"
        echo -e "${YELLOW}Input:${NC}"; head -n 10 "$input_file"; [ $(wc -l < "$input_file") -gt 10 ] && echo "..."
        [ -f "$expected_file" ] && { echo -e "${YELLOW}Expected:${NC}"; head -n 10 "$expected_file"; [ $(wc -l < "$expected_file") -gt 10 ] && echo "..."; }
        echo -e "${YELLOW}Got:${NC}"; head -n 10 "$my_output"; [ $(wc -l < "$my_output") -gt 10 ] && echo "..."
        echo "--------------------------------"
    fi
done

# Cleanup
rm -f "$EXE_NAME" "$CHECKER_EXE" "$GEN_EXE" "$FAST_EXE"
[ -n "$CLEAN_SOURCE_FILE" ] && [ -f "$CLEAN_SOURCE_FILE" ] && rm "$CLEAN_SOURCE_FILE"

if [ "$TESTS_FOUND" = false ]; then echo -e "${YELLOW}Tests not found (.in files)!${NC}"; fi
