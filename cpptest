#!/bin/bash

# ==========================================
# CONFIGURATION
# ==========================================
CONFIG_FILE="$HOME/.cpptest_compiler"
CXX_FLAGS="-std=c++17 -O2 -Wall -Wextra -pedantic -Werror"
REPO_URL="https://github.com/MootSasa/CppTest.git"

# Default Generator Settings
GEN_DEFAULT_COUNT=100
GEN_DEFAULT_ARGS="-100 100"
GEN_CONFIG_FILE="tests.cfg"

# Directories names
TESTS_DIR_NAME="tests"
GEN_DIR_NAME="gen_tests"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==========================================
# HELPER FUNCTIONS
# ==========================================
find_compilers() {
    IFS=: read -ra PATH_DIRS <<< "$PATH"
    PATTERNS=("g++*" "clang++*" "c++*")
    CANDIDATES=()
    for dir in "${PATH_DIRS[@]}"; do
        [ -d "$dir" ] || continue
        for pat in "${PATTERNS[@]}"; do
            shopt -s nullglob
            for file in "$dir"/$pat; do
                [ -x "$file" ] || continue
                name=$(basename "$file")
                if [[ "$name" =~ ^(g\+\+|clang\+\+|c\+\+)(-[0-9]+)?$ ]]; then
                    CANDIDATES+=("$name")
                fi
            done
            shopt -u nullglob
        done
    done
    readarray -t INSTALLED_COMPILERS < <(printf "%s\n" "${CANDIDATES[@]}" | sort -u | sort -V -r)
}

# ==========================================
# PARSE ARGUMENTS
# ==========================================
CPP_FILE=""
SPECIFIC_TEST=""
SOURCE_DIR="."
ISOLATE=true
CHECKER_MODE="auto"
SKIP_LINTER=false
AUTO_FIX=false
REMOVE_COMMENTS=false
STRESS_MODE=false
IGNORE_GEN_CONFIG=false
GEN_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--update)
            echo -e "${BLUE}Updating CppTest from GitHub...${NC}"
            CMD="rm -rf /tmp/cpptest_inst && git clone --depth=1 $REPO_URL /tmp/cpptest_inst && bash /tmp/cpptest_inst/install.sh && rm -rf /tmp/cpptest_inst"
            eval "$CMD"
            if [ $? -eq 0 ]; then echo -e "${GREEN}Update complete!${NC}"; exit 0; else echo -e "${RED}Update failed!${NC}"; exit 1; fi ;;
        
        -l|--list) find_compilers; echo -e "${BLUE}Detected Compilers:${NC}"; for i in "${!INSTALLED_COMPILERS[@]}"; do echo " - ${INSTALLED_COMPILERS[$i]}"; done; exit 0 ;;
        
        -s|--select)
            find_compilers; [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No compilers found!${NC}"; exit 1; }
            echo -e "${BLUE}Select default compiler:${NC}"; select opt in "${INSTALLED_COMPILERS[@]}"; do if [ -n "$opt" ]; then echo "$opt" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $opt${NC}"; exit 0; else echo -e "${RED}Invalid selection${NC}"; fi; done; exit 0 ;;
        
        -c|--compiler) [ -z "$2" ] && { echo -e "${RED}Error: Missing compiler name${NC}"; exit 1; }; echo "$2" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $2${NC}"; exit 0 ;;
        
        -i|--in-place) ISOLATE=false; shift ;;
        -K|--force-checker) CHECKER_MODE="force_check"; shift ;;
        -k|--force-diff) CHECKER_MODE="force_diff"; shift ;;
        -f|--fast) SKIP_LINTER=true; shift ;;
        -F|--fix) AUTO_FIX=true; if [ "$ISOLATE" = true ]; then ISOLATE=false; fi; shift ;;
        -R|--no-comments) REMOVE_COMMENTS=true; if [ "$ISOLATE" = true ]; then ISOLATE=false; fi; shift ;;
        -S|--stress) STRESS_MODE=true; shift ;;
        -G|--no-gen-config) IGNORE_GEN_CONFIG=true; shift ;;
        -g|--gen-only) GEN_ONLY=true; shift ;;
        
        *)
            if [[ -d "$1" ]]; then
                SOURCE_DIR="$1"
            elif [[ "$1" == *.in ]]; then
                if [[ -f "$1" ]]; then
                    SPECIFIC_TEST=$(realpath "$1")
                    SOURCE_DIR=$(dirname "$SPECIFIC_TEST")
                else
                    echo -e "${RED}Error: Test file '$1' not found.${NC}"; exit 1
                fi
            elif [[ -f "$1" ]]; then
                SOURCE_DIR=$(dirname "$1")
                CPP_FILE=$(basename "$1")
            elif [[ "$1" != -* ]]; then
                 CPP_FILE="$1"
            fi
            shift ;;
    esac
done

# ==========================================
# PATH RESOLUTION
# ==========================================
SOURCE_DIR=$(realpath "$SOURCE_DIR")

# Define PERSISTENT paths for tests (always in user's folder)
REAL_GEN_DIR="$SOURCE_DIR/$GEN_DIR_NAME"
REAL_TESTS_DIR="$SOURCE_DIR/$TESTS_DIR_NAME"

# Determine Workspace
if [ "$STRESS_MODE" = true ]; then
    if [ "$ISOLATE" = true ]; then WORK_DIR="/tmp/cpptest/stress"; else WORK_DIR="$SOURCE_DIR/stress"; fi
else
    if [ "$ISOLATE" = true ]; then WORK_DIR="/tmp/cpptest/tmp"; else WORK_DIR="$SOURCE_DIR"; fi
fi

# ==========================================
# ENVIRONMENT PREPARATION
# ==========================================
if [ "$ISOLATE" = true ] || [ "$STRESS_MODE" = true ]; then
    echo -e "${BLUE}=== Environment: $WORK_DIR ===${NC}"
    rm -rf "$WORK_DIR"
    mkdir -p "$WORK_DIR"
    cp -a "$SOURCE_DIR/." "$WORK_DIR/"
    cd "$WORK_DIR" || exit 1
else
    echo -e "${BLUE}=== Environment: In-Place ($SOURCE_DIR) ===${NC}"
    cd "$SOURCE_DIR" || exit 1
fi

# ==========================================
# COMPILER SETUP
# ==========================================
if [ -f "$CONFIG_FILE" ]; then CHOSEN_CXX=$(cat "$CONFIG_FILE"); if ! command -v "$CHOSEN_CXX" &> /dev/null; then CHOSEN_CXX=""; fi; fi
if [ -z "$CHOSEN_CXX" ]; then find_compilers; [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No C++ compiler found!${NC}"; exit 1; }; CHOSEN_CXX=${INSTALLED_COMPILERS[0]}; echo -e "${YELLOW}No default set. Using: $CHOSEN_CXX${NC}"; fi

if [ "$GEN_ONLY" = false ]; then
    if [ -z "$CPP_FILE" ]; then CPP_FILE=$(ls *.cpp 2>/dev/null | grep -vE "check.cpp|gen.cpp|fast.cpp" | head -n 1); fi
    [ -z "$CPP_FILE" ] && { echo -e "${RED}Error: Main C++ file not found!${NC}"; exit 1; }
fi

EXE_NAME="solution_exec"
GEN_EXE="gen_exec"
FAST_EXE="fast_exec"
CHECKER_EXE="checker_exec"

# ==========================================
# ACTION: REMOVE COMMENTS (-R)
# ==========================================
if [ "$REMOVE_COMMENTS" = true ] && [ -n "$CPP_FILE" ]; then
    echo -e "${BLUE}=== Removing Comments ===${NC}"
    # Use perl to modify file in-place (-i)
    perl -0777 -pi -e 's{ ("(?:\\. | [^\\"])*") | /\*.*?\*/ | // [^\n]* }{ $1 || "" }gsex' "$CPP_FILE"
    echo -e "${GREEN}Comments removed from $CPP_FILE.${NC}"
    echo -e "${YELLOW}Exiting (Clean-only mode).${NC}"
    exit 0
fi

# ==========================================
# ACTION: AUTO FIX (-F)
# ==========================================
if [ "$AUTO_FIX" = true ] && [ -n "$CPP_FILE" ]; then
    echo -e "${BLUE}=== Applying Auto-Fixes ===${NC}"
    if command -v clang-format &> /dev/null; then clang-format -i "$CPP_FILE"; echo " - Formatting applied."; fi
    if command -v clang-tidy &> /dev/null; then echo " - Applying Clang-Tidy fixes..."; clang-tidy -quiet --fix "$CPP_FILE" -- $CXX_FLAGS > /dev/null 2>&1; fi
    echo -e "${GREEN}Fixes applied.${NC}\n"
fi

# ==========================================
# GENERATION PHASE
# ==========================================
if [ -f "gen.cpp" ]; then
    echo -e "${BLUE}=== Compiling Generator (gen.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "gen.cpp" -o "$GEN_EXE"
    if [ $? -ne 0 ]; then echo -e "${RED}GENERATOR COMPILATION ERROR${NC}"; exit 1; fi

    echo -e "${BLUE}=== Generating Tests ===${NC}"
    echo -e "Target: $REAL_GEN_DIR/"
    
    # Create persistent gen directory in source
    mkdir -p "$REAL_GEN_DIR"
    CNT=1
    
    generate_batch() {
        local count=$1; shift; local args="$@"
        for ((i=1; i<=count; i++)); do 
            # Write directly to the persistent folder
            ./"$GEN_EXE" $args > "$REAL_GEN_DIR/gen_${CNT}.in"
            ((CNT++))
        done
        echo " - Generated $count tests"
    }

    if [ "$IGNORE_GEN_CONFIG" = false ] && [ -f "$GEN_CONFIG_FILE" ]; then
        echo "Reading $GEN_CONFIG_FILE..."
        while read -r line || [ -n "$line" ]; do
            [[ "$line" =~ ^#.*$ ]] && continue
            [[ -z "$line" ]] && continue
            read -r count args <<< "$line"
            generate_batch "$count" "$args"
        done < "$GEN_CONFIG_FILE"
    else
        echo "Using default: 100 tests, args: $GEN_DEFAULT_ARGS"
        generate_batch $GEN_DEFAULT_COUNT $GEN_DEFAULT_ARGS
    fi
    echo -e "${GREEN}Generation complete.${NC}\n"
fi

# IF GEN-ONLY, EXIT
if [ "$GEN_ONLY" = true ]; then
    echo -e "${GREEN}Done. (-g flag used).${NC}"
    rm -f "$GEN_EXE"
    exit 0
fi

# ==========================================
# LINTERS
# ==========================================
if [ "$SKIP_LINTER" = false ]; then
    if command -v clang-format &> /dev/null; then
        echo -e "${BLUE}=== Checking Formatting ===${NC}"
        clang-format --dry-run --Werror "$CPP_FILE" 2> /dev/null
        if [ $? -ne 0 ]; then echo -e "${RED}CLANG-FORMAT FAILED${NC} (Use -F to fix)"; exit 1; fi
        echo -e "${BLUE}Formatting OK.${NC}\n"
    fi
    if command -v clang-tidy &> /dev/null; then
        echo -e "${BLUE}=== Running Clang-Tidy ===${NC}"
        clang-tidy -quiet "$CPP_FILE" -- $CXX_FLAGS
        if [ $? -ne 0 ]; then echo -e "\n${RED}CLANG-TIDY FAILED${NC} (Use -F to fix)"; exit 1; fi
        echo -e "${BLUE}Analysis complete.${NC}\n"
    fi
else
    echo -e "${YELLOW}Skipping linters (-f used).${NC}\n"
fi

# ==========================================
# COMPILATION
# ==========================================
echo -e "${BLUE}=== Compiling Main ($CPP_FILE) ===${NC}"
$CHOSEN_CXX $CXX_FLAGS "$CPP_FILE" -o "$EXE_NAME"
if [ $? -ne 0 ]; then echo -e "${RED}COMPILATION ERROR${NC}"; exit 1; fi

if [ "$STRESS_MODE" = true ] && [ -f "fast.cpp" ]; then
    echo -e "${BLUE}=== Compiling Brute-Force (fast.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "fast.cpp" -o "$FAST_EXE"
    [ $? -ne 0 ] && { echo -e "${RED}FAST.CPP COMPILATION ERROR${NC}"; exit 1; }
fi

# ==========================================
# CHECKER SETUP
# ==========================================
HAS_CHECKER=false
if [ "$CHECKER_MODE" == "force_diff" ]; then
    echo -e "${BLUE}Checker: Forced Standard Diff (-k)${NC}"
elif [ -f "check.cpp" ]; then
    echo -e "${BLUE}=== Compiling Custom Checker (check.cpp) ===${NC}"
    $CHOSEN_CXX -O2 "check.cpp" -o "$CHECKER_EXE"
    [ $? -ne 0 ] && { echo -e "${RED}CHECKER COMPILATION ERROR${NC}"; exit 1; }
    HAS_CHECKER=true
    echo -e "${GREEN}Checker ready.${NC}\n"
else
    if [ "$CHECKER_MODE" == "force_check" ]; then
        echo -e "${RED}Error: Custom checker (-K) requested, but 'check.cpp' not found!${NC}"; exit 1
    fi
    echo -e "${BLUE}Checker: Standard Diff (check.cpp not found)${NC}\n"
fi

# ==========================================
# STRESS TESTING MODE
# ==========================================
if [ "$STRESS_MODE" = true ]; then
    if [ ! -f "gen.cpp" ] || [ ! -f "fast.cpp" ]; then
        echo -e "${RED}Error: Stress mode requires 'gen.cpp' and 'fast.cpp'.${NC}"; exit 1
    fi

    echo -e "${BLUE}=== STARTING STRESS TEST ===${NC}"
    echo -e "Using Checker: $(if [ "$HAS_CHECKER" = true ]; then echo "check.cpp"; else echo "diff"; fi)"
    echo -e "Press Ctrl+C to stop.\n"
    
    mkdir -p stress_data
    
    TEST_COUNT=1
    while true; do
        # Generate random input
        ./"$GEN_EXE" $GEN_DEFAULT_ARGS > stress_data/stress.in
        
        # Run Solutions
        ./"$EXE_NAME" < stress_data/stress.in > stress_data/stress.out
        ./"$FAST_EXE" < stress_data/stress.in > stress_data/stress.ans
        
        # Verify
        VERDICT="OK"
        if [ "$HAS_CHECKER" = true ]; then
            ./"$CHECKER_EXE" "stress_data/stress.in" "stress_data/stress.out" "stress_data/stress.ans" > /dev/null 2>&1
            if [ $? -ne 0 ]; then VERDICT="WA"; fi
        else
            diff -w -B stress_data/stress.out stress_data/stress.ans > /dev/null
            if [ $? -ne 0 ]; then VERDICT="WA"; fi
        fi

        if [ "$VERDICT" == "OK" ]; then
            echo -ne "\r${GREEN}Test #$TEST_COUNT: OK${NC}"
        else
            echo -e "\n${RED}Test #$TEST_COUNT: FAILED!${NC}"
            echo -e "${YELLOW}Input:${NC}"; cat stress_data/stress.in
            echo -e "${YELLOW}Main Output:${NC}"; cat stress_data/stress.out
            echo -e "${YELLOW}Fast Output:${NC}"; cat stress_data/stress.ans
            echo "--------------------------------"
            exit 1
        fi
        ((TEST_COUNT++))
    done
fi

# ==========================================
# NORMAL TESTING: RUN LOOP
# ==========================================
if [ -n "$SPECIFIC_TEST" ]; then
    ALL_INPUT_FILES="$SPECIFIC_TEST"
    echo -e "${BLUE}Running specific test: $(basename "$SPECIFIC_TEST")${NC}"
else
    # Find all .in files in CURRENT work dir AND in persistent Source dir folders
    # We use 'find' with multiple paths.
    # Note: If ISOLATE=true, the current dir is /tmp/... but we explicitly point to source/gen_tests
    ALL_INPUT_FILES=$(find . "$REAL_TESTS_DIR" "$REAL_GEN_DIR" -maxdepth 1 -name "*.in" 2>/dev/null | sort -V | uniq)
fi

if [ -z "$ALL_INPUT_FILES" ]; then
    echo -e "${YELLOW}Tests not found! (Checked: root, $TESTS_DIR_NAME/, $GEN_DIR_NAME/)${NC}"
    rm -f "$EXE_NAME" "$CHECKER_EXE" "$GEN_EXE" "$FAST_EXE"
    exit 0
fi

for input_file in $ALL_INPUT_FILES; do
    dir_name=$(dirname "$input_file")
    base_name=$(basename "$input_file" .in)
    expected_file="$dir_name/$base_name.out"
    my_output="$dir_name/$base_name.my"
    
    echo -n "Test $base_name: "
    
    start_time=$(date +%s%N)
    ./"$EXE_NAME" < "$input_file" > "$my_output"
    exit_code=$?
    end_time=$(date +%s%N)
    duration=$(( ($end_time - $start_time) / 1000000 ))

    if [ $exit_code -ne 0 ]; then
        echo -e "${RED}RUNTIME ERROR (Code $exit_code)${NC} [${duration}ms]"
        continue
    fi

    VERDICT="OK"
    if [ "$HAS_CHECKER" = true ]; then
        [ ! -f "$expected_file" ] && touch "$expected_file"
        ./"$CHECKER_EXE" "$input_file" "$my_output" "$expected_file" > /dev/null 2>&1
        [ $? -eq 0 ] && VERDICT="OK" || VERDICT="WA"
    else
        if [ ! -f "$expected_file" ]; then
             if [ "$CHECKER_MODE" == "force_diff" ]; then echo -e "${RED}Error: .out missing (-k active)${NC}"; continue; else VERDICT="RUN"; fi
        else
             diff -w -B "$my_output" "$expected_file" > /dev/null && VERDICT="OK" || VERDICT="WA"
        fi
    fi

    if [ "$VERDICT" == "OK" ]; then
        echo -e "${GREEN}OK${NC} [${duration}ms]"
        rm "$my_output"
    elif [ "$VERDICT" == "RUN" ]; then
        echo -e "${BLUE}Run (no .out)${NC} [${duration}ms]"
        rm "$my_output"
    else
        echo -e "${RED}WA (Wrong Answer)${NC} [${duration}ms]"
        echo -e "${YELLOW}Input:${NC}"; head -n 10 "$input_file"; [ $(wc -l < "$input_file") -gt 10 ] && echo "..."
        [ -f "$expected_file" ] && { echo -e "${YELLOW}Expected:${NC}"; head -n 10 "$expected_file"; [ $(wc -l < "$expected_file") -gt 10 ] && echo "..."; }
        echo -e "${YELLOW}Got:${NC}"; head -n 10 "$my_output"; [ $(wc -l < "$my_output") -gt 10 ] && echo "..."
        echo "--------------------------------"
    fi
done

# Cleanup
rm -f "$EXE_NAME" "$CHECKER_EXE" "$GEN_EXE" "$FAST_EXE"
