#!/bin/bash

# ==========================================
# CONFIGURATION
# ==========================================
CONFIG_FILE="$HOME/.cpptest_compiler"
CXX_FLAGS="-std=c++17 -O2 -Wall -Wextra -pedantic -Werror"
TMP_WORK_DIR="/tmp/cpptest/tmp"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==========================================
# HELPER FUNCTIONS
# ==========================================
find_compilers() {
    IFS=: read -ra PATH_DIRS <<< "$PATH"
    PATTERNS=("g++*" "clang++*" "c++*")
    CANDIDATES=()
    for dir in "${PATH_DIRS[@]}"; do
        [ -d "$dir" ] || continue
        for pat in "${PATTERNS[@]}"; do
            shopt -s nullglob
            for file in "$dir"/$pat; do
                [ -x "$file" ] || continue
                name=$(basename "$file")
                if [[ "$name" =~ ^(g\+\+|clang\+\+|c\+\+)(-[0-9]+)?$ ]]; then
                    CANDIDATES+=("$name")
                fi
            done
            shopt -u nullglob
        done
    done
    readarray -t INSTALLED_COMPILERS < <(printf "%s\n" "${CANDIDATES[@]}" | sort -u | sort -V -r)
}

# ==========================================
# PARSE ARGUMENTS
# ==========================================
CPP_FILE=""
SOURCE_DIR="."
ISOLATE=true        # Default: Copy to tmp
CHECKER_MODE="auto" # auto, force_check (-K), force_diff (-k)
SKIP_LINTER=false   # Default: Run linter

while [[ $# -gt 0 ]]; do
    case $1 in
        -l|--list)
            find_compilers
            echo -e "${BLUE}Detected Compilers:${NC}"
            for i in "${!INSTALLED_COMPILERS[@]}"; do echo " - ${INSTALLED_COMPILERS[$i]}"; done
            exit 0 ;;
        -s|--select)
            find_compilers
            [ ${#INSTALLED_COMPILERS[@]} -eq 0 ] && { echo -e "${RED}Error: No compilers found!${NC}"; exit 1; }
            echo -e "${BLUE}Select default compiler:${NC}"
            select opt in "${INSTALLED_COMPILERS[@]}"; do
                if [ -n "$opt" ]; then
                    echo "$opt" > "$CONFIG_FILE"
                    echo -e "${GREEN}Default compiler set to: $opt${NC}"
                    exit 0
                else echo -e "${RED}Invalid selection${NC}"; fi
            done
            exit 0 ;;
        -c|--compiler)
            [ -z "$2" ] && { echo -e "${RED}Error: Missing compiler name${NC}"; exit 1; }
            echo "$2" > "$CONFIG_FILE"; echo -e "${GREEN}Default compiler set to: $2${NC}"; exit 0 ;;
        
        # --- NEW FLAGS ---
        -i|--in-place)
            ISOLATE=false
            shift ;;
        -K|--force-checker)
            CHECKER_MODE="force_check"
            shift ;;
        -k|--force-diff)
            CHECKER_MODE="force_diff"
            shift ;;
        -f|--fast)
            SKIP_LINTER=true
            shift ;;
        
        *)
            if [[ -d "$1" ]]; then
                SOURCE_DIR="$1"
            elif [[ -f "$1" ]]; then
                SOURCE_DIR=$(dirname "$1")
                CPP_FILE=$(basename "$1")
            elif [[ "$1" != -* ]]; then
                 CPP_FILE="$1"
            fi
            shift ;;
    esac
done

# ==========================================
# ENVIRONMENT SETUP (Isolation)
# ==========================================
# Resolve absolute path for Source Directory
SOURCE_DIR=$(realpath "$SOURCE_DIR")

if [ "$ISOLATE" = true ]; then
    echo -e "${BLUE}=== Environment: Isolated ($TMP_WORK_DIR) ===${NC}"
    rm -rf "$TMP_WORK_DIR"
    mkdir -p "$TMP_WORK_DIR"
    
    # Copy all 
